#!/usr/bin/env bash

# The Cloud Foundry Python Buildpack. This script accepts parameters for a build
# directory, a cache directory, and a directory for app environment variables.
#
#     $ ./bin/supply <build_dir> <cache_dir> <deps_dir> <deps_index>

# Paths.
BIN_DIR=$(cd $(dirname $0); pwd) # absolute path
ROOT_DIR=$(dirname $BIN_DIR)
BUILD_DIR=$1
CACHE_DIR=$2
DEPS_DIR=$3
DEPS_IDX=$4
export BIN_DIR BUILD_DIR CACHE_DIR DEPS_DIR DEPS_IDX

# START CF Common
export BUILDPACK_PATH=$ROOT_DIR
export BUILDPACK_DIR=$ROOT_DIR
source $ROOT_DIR/compile-extensions/lib/common
$ROOT_DIR/compile-extensions/bin/check_buildpack_version $ROOT_DIR $CACHE_DIR

if [ -n "$DEPS_DIR" ]; then
  env_vars=$($BUILDPACK_PATH/compile-extensions/bin/build_path_from_supply $DEPS_DIR)
  for env_var in $env_vars; do
    export $env_var
  done
fi
# END CF Common

$ROOT_DIR/compile-extensions/bin/check_stack_support

PIP_VERSION="9.0.1"
SETUPTOOLS_VERSION="32.1.0"

# Common Problem Warnings
export WARNINGS_LOG=$(mktemp)
export RECOMMENDED_PYTHON_VERSION=$DEFAULT_PYTHON_VERSION

# Prepend proper environment variables for Python use.
export PYTHONUNBUFFERED=1
export LANG=en_US.UTF-8

## TODO we may need something special for this
# export PKG_CONFIG_PATH=/app/.cloudfoundry/vendor/lib/pkg-config:/app/.cloudfoundry/python/lib/pkg-config:$PKG_CONFIG_PATH

# Switch to the repo's context.
cd $BUILD_DIR

# Warn for lack of Procfile.
if [[ ! -f Procfile ]]; then
  puts-warn 'Warning: Your application is missing a Procfile. This file tells Cloud Foundry how to run your application.'
  puts-warn 'Learn more: https://docs.cloudfoundry.org/buildpacks/prod-server.html#procfile'
fi

export PYTHONUNBUFFERED=1
export LANG=en_US.UTF-8
export PATH=$DEPS_DIR/$DEPS_IDX/bin:$PATH
export C_INCLUDE_PATH=$DEPS_DIR/$DEPS_IDX/include:$C_INCLUDE_PATH
export CPLUS_INCLUDE_PATH=$DEPS_DIR/$DEPS_IDX/include:$CPLUS_INCLUDE_PATH
export LIBRARY_PATH=$DEPS_DIR/$DEPS_IDX/lib:$LIBRARY_PATH
export LD_LIBRARY_PATH=$DEPS_DIR/$DEPS_IDX/lib:$LD_LIBRARY_PATH
export PKG_CONFIG_PATH=$DEPS_DIR/$DEPS_IDX/lib/pkg-config:$PKG_CONFIG_PATH

# Install pip-pop
mv $BUILDPACK_DIR/vendor/pip-pop $DEPS_DIR/$DEPS_IDX/pip-pop

# Experimental pre_compile hook.
source $BIN_DIR/steps/hooks/pre_compile ## TODO ; here or in finalize?

# Install Python.
source $BIN_DIR/steps/python
