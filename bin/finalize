#!/usr/bin/env bash

# The Cloud Foundry Python Buildpack. This script accepts parameters for a build
# directory, a cache directory, and a directory for app environment variables.

# Usage:
#
#     $ bin/finalize <build-dir> <cache-dir> <deps_dir> <deps_index>

# Fail fast and fail hard.
set -eo pipefail

# Paths.
BIN_DIR=$(cd $(dirname $0); pwd) # absolute path
ROOT_DIR=$(dirname $BIN_DIR)
BUILD_DIR=$1
CACHE_DIR=$2
DEPS_DIR=$3
DEPS_IDX=$4
export BIN_DIR BUILD_DIR CACHE_DIR DEPS_DIR DEPS_IDX

# CF Common
BUILDPACK_PATH=$ROOT_DIR
export BUILDPACK_PATH

env_vars=$($BUILDPACK_PATH/compile-extensions/bin/build_path_from_supply $DEPS_DIR)
for env_var in $env_vars; do
  export $env_var
done
$BUILDPACK_PATH/compile-extensions/bin/write_profiled_from_supply $DEPS_DIR $BUILD_DIR

# Syntax sugar.
source $BIN_DIR/utils

# Use miniconda if environment.yml exists and exit
if [ -f $BUILD_DIR/environment.yml ]; then

  $BIN_DIR/steps/conda-finalize

  # Experimental post_compile hook.
  pushd $BUILD_DIR >/dev/null
    source $BIN_DIR/steps/hooks/post_compile
  popd >/dev/null

  $BUILDPACK_PATH/compile-extensions/bin/write_profiled_from_supply $DEPS_DIR $BUILD_DIR
  $ROOT_DIR/compile-extensions/bin/store_buildpack_metadata $ROOT_DIR $CACHE_DIR

  exit 0
fi


# Switch to the repo's context.
cd $BUILD_DIR

# Uninstall removed dependencies with Pip.
source $BIN_DIR/steps/pip-uninstall

# Install dependencies with Pip (where the magic happens).
source $BIN_DIR/steps/pip-install

# Make sure all Pip installed dependencies use #!/usr/bin/env python
$BIN_DIR/steps/rewrite-shebang

# Support for NLTK corpora.
$BIN_DIR/steps/nltk

# Django collectstatic support.
$BIN_DIR/steps/collectstatic

# Experimental post_compile hook.
source $BIN_DIR/steps/hooks/post_compile

# rewrite build dir in egg links to runtime $DEPS_DIR/app so things can be found
cat << EOF > $DEPS_DIR/$DEPS_IDX/profile.d/python.fix-eggs.sh
find \$DEPS_DIR/$DEPS_IDX/python/lib/python*/site-packages/  -name "*.pth" -print0 2> /dev/null | xargs -r -0 -n 1 sed -i -e "s#$DEPS_DIR/$DEPS_IDX#\$DEPS_DIR/$DEPS_IDX#" &> /dev/null
find \$DEPS_DIR/$DEPS_IDX/python/lib-python/*/site-packages/  -name "*.pth" -print0 2> /dev/null | xargs -r -0 -n 1 sed -i -e "s#$DEPS_DIR/$DEPS_IDX#\$DEPS_DIR/$DEPS_IDX#" &> /dev/null
EOF

# cache everything
cp -Rl $DEPS_DIR/$DEPS_IDX/python $CACHE_DIR/
cp -Rl $DEPS_DIR/$DEPS_IDX/vendor $CACHE_DIR/ &> /dev/null || true
if [[ -d $DEPS_DIR/$DEPS_IDX/src ]]; then
	cp -Rl $DEPS_DIR/$DEPS_IDX/src $CACHE_DIR/ &> /dev/null || true
fi

$BUILDPACK_PATH/compile-extensions/bin/write_profiled_from_supply $DEPS_DIR $BUILD_DIR
$ROOT_DIR/compile-extensions/bin/store_buildpack_metadata $ROOT_DIR $CACHE_DIR
# Fin.
